---
title: 'The Woods Hole Assessment Model (WHAM): a general state-space assessment framework that incorporates time- and age-varying processes via random effects and links to environmental covariates'
author: Brian C. Stock^1^, Timothy J. Miller^1^
date: ''
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    number_sections: true
    includes:
      in_header: options.sty
csl: fisheries-research.csl
bibliography: wham-sim.bib
nocite: |
  @nefsc2020Operational, @nefsc2020Butterfish, @ices2017Report, @ices2017Reporta
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE, fig.align = "center")
knitr::opts_knit$set(root.dir = '../' )
library(knitr)
library(tidyverse)
# library(cowplot)
# library(ggsidekick)
library(pander)
library(kableExtra)
library(png)
library(forcats)
library(wham)
# library(ggplotFL)
# library(ggsci)
```

$^1$brian.stock@noaa.gov, timothy.j.miller@noaa.gov, Northeast Fisheries Science Center, National Marine Fisheries Service, 166 Water Street, Woods Hole, MA 02543, USA\

\pagebreak

## Abstract {-}

The rapid changes observed in many marine ecosystems that support fisheries pose a challenge to stock assessment and management predicated on time-invariant productivity and considering species in isolation. In single-species assessments, two main approaches have been used to account for productivity changes: allowing biological parameters to vary stochastically over time (empirical), or explicitly linking population processes such as recruitment (*R*) or natural mortality (*M*) to environmental covariates (mechanistic). Here, we describe the Woods Hole Assessment Model (WHAM) framework and software package, which combines these two approaches. WHAM can estimate time- and age-varying random effects on annual transitions in numbers at age (NAA), *M*, and selectivity, as well as fit environmental time-series with process and observation errors, missing data, and nonlinear links to *R* and *M*. WHAM can also be configured as a traditional statistical catch-at-age (SCAA) model in order to easily bridge from status quo models and test them against models with state-space and environmental effects, all within a single framework.

We fit models with and without (independent or autocorrelated) random effects on NAA, *M*, and selectivity to data from five stocks with a broad range of life history, fishing pressure, number of ages, and time-series length. Models that included random effects performed well across stocks and processes, especially random effects models with a two dimensional (2D) first-order autoregressive (AR1) covariance structure over age and year. We conducted simulation tests and found negligible or no bias in estimation of important assessment outputs (SSB, *F*, stock status, and catch) when the operating and estimation models matched. However, bias in SSB and *F* was often non-trivial when the estimation model was less complex than the operating model, especially when models without random effects were fit to data simulated from models with random effects. Bias of the variance and correlation parameters controlling random effects was also negligible or slightly negative as expected. Our results suggest that WHAM can be a useful tool for stock assessment when environmental effects on *R* or *M*, or stochastic variation in NAA transitions, *M*, or selectivity are of interest. In the U.S. Northeast, where the productivity of several groundfish stocks has declined, conducting assessments in WHAM with time-varying processes via random effects or environment-productivity links may account for these trends and potentially reduce retrospective bias.

### Keywords {-}

state-space; stock assessment; random effects; time-varying; environmental effects; recruitment; natural mortality; Template Model Builder (TMB)

\pagebreak

# Introduction  

The last two decades have increasingly seen a push for more holistic, ecosystem-based fisheries management [@larkin1996Concepts; @link2002What]. In part, this is a recognition that considering single species in isolation produces riskier and less robust outcomes long-term [@patrick2015Myths]. In several high-profile cases, fisheries management has failed to prevent collapses because they did not reduce fishing pressure in responses to changes in natural mortality ($M$), recruitment, or migration patterns caused by dynamics external to the stock in question [Northern cod: @shelton2006Fishing; @rose2015Northern; Gulf of Maine cod: @pershing2015Slow; Pacific sardine: @zwolinski2012Cold]. This is particularly concerning in the context of climate change and the wide range of biological processes—often assumed to be constant—in stock assessments that are likely to be affected [@stock2011Use; @tommasi2017Managing].

One approach to account for changing productivity is to explicitly link population processes to environmental covariates in single-species stock assessments, i.e. the mechanistic approach *sensu* @punt2014Fisheries. Traditional single-species assessments are based on internal population dynamics and the effect of fishing mortality ($F$), even though fisheries scientists have long known about important drivers of time-varying population processes, e.g. recruitment, mortality, growth, and movement [@garstang1900Impoverishment; @hjort1914Fluctuations]. Effects of the environment or interactions with other species can be considered contextually, rather than explicitly as estimated parameters (although temporal variation in empirical weight and maturity at age can affect reference points). Despite how counterintuitive this may seem to ecologists and oceanographers who study such relationships, the evidence for direct linkages to specific environmental covariates is often weak and can break down over time [@mcclatchie2010Reassessment; @myers1998When]. Additionally, the primary goal of most assessments is to provide management advice on near-term sustainable harvest levels—not to explain ecological relationships. Even if an environmental covariate directly affects fish productivity, including the effect in an assessment may not improve management advice if the effect is weak [@deoliveira2005Limits]. Worse, including environmental effects in an assessment or management system has been shown to actually provide worse management in some cases [@deoliveira2005Limits; @punt2014Fisheries; @walters1988Research]. This can be true even in cases of relatively well-understood mechanistic links between oceanic conditions and fish populations, as in the case of sea surface temperature and Pacific sardine [@hill2018Assessment; @zwolinski2012Cold]. Still, incorporating mechanistic environment-productivity links in assessments does have the potential to reduce residual variance, particularly in periods when few demographic data exist [@miller2016Statespace; @shotwell2014Biophysical].

An alternative approach is to allow biological parameters to vary stochastically over time, i.e. the empirical approach *sensu* @punt2014Fisheries. In this case, the variation is caused by a range of sources that are not explicitly modeled. Statistical catch-at-age (SCAA) models typically only estimate year-specific recruitment ($R_t$) and $F_t$, often as deviations from a mean, $R_0$, that may or may not be a function of spawning biomass, e.g. $\text{log}R_t = \text{log}R_0 + \epsilon_t$. The main reason that other parameters are assumed constant is simply that there are not enough degrees of freedom to estimate many time-varying parameters. A common solution is to penalize the deviations, e.g. $\epsilon_t \sim \mathcal{N}(0,\sigma^2_\epsilon)$, although the penalty terms, $\sigma^2_\epsilon$, must be fixed or iteratively tuned and are therefore somewhat subjective [@methot2011Adjusting; @methot2013Stock; @xu2020Comparing; @aeberhard2018Review]. State-space models that treat parameters as unobserved states can, in principle, avoid such subjectivity by estimating the penalty terms as variance parameters constraining random effects and maximizing the marginal likelihood [@thorson2019Perspective]. In this way, state-space models can allow processes to vary in time while simultaneously estimating fewer parameters. 

Although state-space stock assessments have existed for some time [@gudmundsson1994Time; @mendelssohn1988Problems; @sullivan1992Kalman], the recent development of Template Model Builder [TMB, @kristensen2016TMB] software to perform efficient Laplace approximation has greatly expanded their use [@cadigan2016Statespace; @miller2016Statespace; @nielsen2014Estimation]. In addition to the key advantage of objectively estimating variance, or "data weighting", parameters, state-space models naturally predict unobserved states, and therefore handle missing data and short-term projections in a straightforward way [@ices2020Workshop]. In comparisons with SCAA models, state-space models have been shown to have larger, more realistic, uncertainty and lower retrospective bias [@miller2018Evaluating; @stockthisissueImplementing].

Retrospective bias can occur when changing environmental conditions lead to changes in productivity that are unaccounted for in stock assessments, and this is a concern common to several groundfish stocks on the Northeast U.S. Shelf [@brooks2016Retrospective; @tableau2018Decadal]. The Northeast U.S. Shelf ecosystem is rapidly changing, and this has motivated managers to make the "continue[d] development of stock assessment models that include environmental terms" a top priority [@hare2016Northeast]. Applications of state-space models with environmental effects on recruitment, growth, $M$, and maturity have proven promising [@miller2018Temporal; @miller2018Evaluating; @oleary2019Understanding; @xu2018Evaluating]. In addition to providing short-term (1-3 years) catch advice with reduced retrospective bias, it is hoped that environment-linked assessments will help create realistic evaluation of sustainable stock and harvest levels in the medium-term (3-10 years) for stocks that have not rebounded in response to dramatic decreases in $F$. <!--For example, @miller2016Statespace developed a state-space model for yellowtail flounder with an environmental effect on recruitment, which reduced retrospective patterns and residual variance. TJM: I took that out because it is repetative with some text a few paragraphs previous.Other applications of similar state-space models that include environmental effects on growth, $M$, and maturity have also proven promising [@miller2018Temporal; @miller2018Evaluating; @oleary2019Understanding; @xu2018Evaluating]. TJM: I commented this out because I couldn't see how to relate it to the previous sentence. BCS: how about just moving it up one sentence like so?--> 

To address the needs of fisheries management in a changing climate, we seek an assessment framework that combines both the empirical and mechanistic approaches. Namely, it should be able to 1) estimate time-varying parameters as random effects (i.e. a state-space model), and 2) include environmental effects directly on biological parameters. The framework should also allow for easy testing against status quo SCAA models to ease gradual adoption through the "research track" or "benchmark" assessment process [@lynch2018Implementing]. The objectives of this manuscript are to introduce the Woods Hole Assessment Model (WHAM) framework and demonstrate its ability to:

1. estimate time- and age-varying random effects on annual changes in abundance at age, $M$, and selectivity;
2. fit environmental time-series with process and observation error, missing data, and a link to a population process; and
3. simulate new data and random effects to conduct self- and cross-tests [*sensu* @deroba2015Simulation] to estimate bias in parameters and derived quantities.

Throughout, we describe how the above are implemented using the open-source WHAM software package [@miller2020Woods].

# Methods

## Model description

WHAM is a generalization and extension of @miller2016Statespace in TMB. It is in many respects similar to the Age-Structured Assessment Program [ASAP, @legault1998Flexible; @miller2015Technical] and can be configured to fit statistical catch-at-age models nearly identically. There is functionality built into WHAM to migrate ASAP input files to R inputs needed for WHAM, and WHAM uses many of the same types of data inputs, such as empirical weight-at-age, so that existing assessments in the U.S. Northeast can be easily replicated and tested against models with state-space and environmental effects in a single framework.

### Processes with random effects

WHAM primarily diverges from ASAP through the implementation of random effects on three processes: inter-annual transitions in numbers at age (*NAA*), natural mortality (*M*), and selectivity (*s*), as well as allowing effects of environmental covariates (*Ecov*) on recruitment and natural mortality [but see ASAP4; @miller2015Technical]. The environmental covariates and their observations are treated using state-space models with true, unobserved values treated as random effects and observation on them having error. Other than environmental covariates, the processes are assumed to have a two dimensional (2D) first-order autoregressive (AR1) covariance structure over age and year, although correlation in either or both dimensions can be turned off. The 2D AR1 structure has been widely used to model deviations by age and year in the parameters $F_{a,y}$ [@nielsen2014Estimation], $M_{a,y}$ [@cadigan2016Statespace; @stockthisissueImplementing], $s_{a,y}$ [@xu2019New], and $N_{a,y}$ [@stockthisissueImplementing], as well as in the catch ($C_{a,y}$) and survey index ($I_{a,y}$) observations [@berg2016Accounting].

#### Numbers at age (*NAA*)

The stock equations in WHAM that describe the transitions between numbers at age are identical to @miller2016Statespace and @nielsen2014Estimation:

\begin{equation}
\label{eq:NAA}
  \text{log}N_{a,y}=\left\{
    \begin{array}{@{}lll@{}}
      \text{log} \left( f(SSB_{y-1}) \right) + \varepsilon_{1,y}, & \text{if}\ a = 1 \\
      \text{log} \left( N_{a-1,y-1} \right) - Z_{a-1,y-1} + \varepsilon_{a,y}, & \text{if}\ 1 < a < A \\
      \text{log} \left( N_{A-1,y-1} e^{-Z_{A-1,y-1}} + N_{A,y-1} e^{-Z_{A,y-1}} \right) + \varepsilon_{A,y}, & \text{if}\ a = A
    \end{array}\right.
\end{equation}

where $N_{a,y}$ are the numbers at age *a* in year *y*, *Z* is the total mortality rate ($F + M$), $f$ is the stock-recruit function, *Y* is the total number of observation and prediction years, and *A* represents the plus-group. In this analysis we demonstrate four possible models for the NAA deviations, $\varepsilon_{a,y}$.

m1 is most similar to a SCAA model, where only recruitment deviations, $\varepsilon_{1,y}$, are estimated (i.e. $\varepsilon_{a,y} = 0$ for $a > 1$ in Eqn \ref{eq:NAA}). In m1, the recruitment deviations are assumed to be independent and identically distributed (IID):

$$\varepsilon_{1,y} \sim \mathcal{N}\left( - \frac{\sigma^2_R}{2}, \sigma^2_R \right)$$
The $- \frac{\sigma^2_R}{2}$ bias correction term is included by default so that the expected recruitment, $E(N_{1,y} = R_y)$ equals the expected $R_y$ from the stock-recruit function [@methot2011Adjusting; @thorson2019Perspective]. This bias correction adjustment can also be turned off. The only difference between m1 and a SCAA is that annual recruitments are random effects and $\sigma^2_R$ is an estimated parameter within the model.

m2 is the same as m1, except that the recruitment deviations are stationary AR1 with autocorrelation parameter $-1<\rho_y<1$:

$$\varepsilon_{1,y+1} \sim \mathcal{N}\left(\rho_y \varepsilon_{1,y} - \frac{\sigma^2_R}{2 (1-\rho^2_y)}, \sigma^2_R \right)$$

m3 is the "full state-space" model from @nielsen2014Estimation and @miller2016Statespace, where all numbers at age are independent random effects and:

\begin{equation}
  \varepsilon_{a,y} \sim \left\{
    \begin{array}{@{}ll@{}}
      \mathcal{N} \left( - \frac{\sigma^2_R}{2}, \sigma^2_R \right), & \text{if}\ a = 1 \\
      \mathcal{N} \left( - \frac{\sigma^2_a}{2}, \sigma^2_a \right), & \text{if}\ a > 1
    \end{array}\right.
\end{equation}

where $\sigma^2_a$ for all ages $a > 1$ are assumed to be the same but different from age $a = 1$, i.e. recruitment. This assumption is sensible because variability of deviations between expected and realized recruitment are typically larger than deviations from expected abundance at older ages.

m4 treats the numbers at all ages as random effects, as in m3, but the NAA deviations, $\varepsilon_{a,y}$, have a 2D stationary AR1 structure as in @stockthisissueImplementing:

$$\mathbf{E} \sim \mathcal{MVN} \left( 0, \Sigma \right)$$

where $\mathbf{E} = (\varepsilon_{1,1}, \ldots, \varepsilon_{1,Y-1}, \varepsilon_{2,1}, \ldots, \varepsilon_{2,Y-1}, \ldots, \varepsilon_{A,1}, \ldots, \varepsilon_{A,Y-1})'$ is a vector of all NAA deviations, $\boldsymbol{\Sigma}$ is the covariance matrix of $\mathbf{E}$ defined by:

$$ \text{Cov} \left( \varepsilon_{a,y}, \varepsilon_{\tilde{a},\tilde{y}} \right) = \frac{\sigma_a \sigma_{\tilde{a}} \rho^{|a-\tilde{a}|}_{a} \rho^{|y-\tilde{y}|}_{y}}{\left(1-\rho^2_{a}\right) \left(1-\rho^2_{y}\right)}$$
and $-1<\rho_a<1$ and $-1<\rho_y<1$ are the AR1 coefficients in age and year, respectively. As in m3, $\sigma^2_a$ for all ages $a > 1$ are assumed to be the same but different from age $a = 1$, $\sigma^2_R$. The bias correction term for age $a > 1$ in m4 is $- \frac{\sigma^2_a}{2 (1-\rho^2_y)(1-\rho^2_a)}$.

#### Natural mortality (*M*)

For natural mortality, there are mean parameters for each age, $\mu_{M_a}$, each of which may be estimated freely or fixed at the initial values. The $\mu_{M_a}$ may also be estimated in sets of ages, e.g. estimate one mean *M* shared across ages 3-5, $\mu_{M_3} = \mu_{M_4} = \mu_{M_5}$. There is also an option for *M* to be specified as a function of weight-at-age, $M_{a,y} = \mu_M \text{W}^b_{a,y}$, as in @lorenzen1996Relationship and @miller2018Evaluating. Regardless of whether $\mu_{M_a}$ are fixed or estimated, WHAM can also be configured to estimate deviations in *M*, $\delta_{a,y}$, as random effects analogous to the NAA deviations [@cadigan2016Statespace; @stockthisissueImplementing]:

\begin{equation}
  \begin{array}{cc}
    \text{log}\left( M_{a,y} \right) = \mu_{M_a} + \delta_{a,y} \\
    \text{Cov} \left( \delta_{a,y}, \delta_{\tilde{a},\tilde{y}} \right) = \frac{\sigma^2_M \varphi^{|a-\tilde{a}|}_{a} \varphi^{|y-\tilde{y}|}_{y}}{\left(1-\varphi^2_{a}\right) \left(1-\varphi^2_{y}\right)}
  \end{array}
\end{equation}

where $\sigma^2_M$, $\varphi_a$, and $\varphi_y$ are the AR1 variance and correlation coefficients in age and year, respectively.

In this analysis, we demonstrate three alternative *M* random effects models. For simplicity, all models treat $\mu_{M_a}$ as known, as in most of the original assessments. m1 is identical to the base *NAA* model, with no random effects on *M* ($\sigma^2_M = \varphi_a = \varphi_y = 0$ and not estimated). m2 allows IID *M* deviations, estimating $\sigma^2_M$ but fixing $\varphi_a = \varphi_y = 0$. m3 estimates the full 2D AR1 structure for *M* deviations.

#### Selectivity (*s*)

As in ASAP and many other SCAA assessment frameworks, WHAM assumes separability in the fishing mortality rate by age and year, e.g. $F_{a,y} = F_y s_a$, where $F_y$ is the "fully selected" fishing mortality rate in year *y* and $s_a$ is the selectivity at age *a*. We note that this differs from the approach in SAM [@nielsen2014Estimation], where the $F_{a,y}$ are estimated directly as multivariate random effects without the separability assumption. Three parametric forms are available (logistic, double-logistic, and decreasing-logistic), as well as a non-parametric option to estimate each $s_a$ individually ("age-specific"). To allow for temporal changes in selectivity as in ASAP, WHAM can estimate selectivity in user-specified time blocks. WHAM estimates selectivity parameters on the logit scale to avoid boundary problems during estimation.

WHAM estimates annual full $F_y$ and mean selectivity parameters as fixed effects. Deviations in selectivity parameters can be estimated as random effects, $\zeta_{p,y}$, with autocorrelation by parameter (*p*), year (*y*), both, or neither. This is done similarly to @xu2019New, except that the deviations are placed on the parameters instead of the mean $s_{a,y}$ in order to guarantee that $0 < s_{a,y} < 1$. For example, logistic selectivity with two parameters $a_{50}$ and $k$ is estimated as:

\begin{equation}
  \begin{array}{cccc}
    s_{a,y} = \frac{1}{1 + e^{-(a - a_{{50}_y}) / k_y}} \\
    a_{{50}_y} = l_{a_{50}} + \frac{u_{a_{50}} - l_{a_{50}}}{1 + e^{-(\nu_1 + \zeta_{1,y})}} \\
    k_y = l_k + \frac{u_k - l_k}{1 + e^{-(\nu_2 + \zeta_{2,y})}} \\
    \text{Cov} \left( \zeta_{1,y}, \zeta_{2,\tilde{y}} \right) = \frac{\sigma^2_s \phi_p \phi^{|y-\tilde{y}|}_{y}}{\left(1-\phi^2_{p}\right) \left(1-\phi^2_{y}\right)}
  \end{array}
\end{equation}

where $\nu_1$ is the logit-scale mean $a_{50}$ parameter with lower and upper bounds $l_{a_{50}}$ and $u_{a_{50}}$, $\nu_2$ is the logit-scale mean $k$ parameter with lower and upper bounds $l_k$ and $u_k$, $\sigma^2_s$ is the AR1 variance, and $\phi_p$, and $\phi_y$ are the AR1 correlation coefficients by parameter and year.

Below, we demonstrate three models with random effect deviations on logistic selectivity, akin to those for *M*. m1 treats all numbers at age as independent random effects (i.e. *NAA* m3) but with no random effects on *s* ($\sigma^2_s = \phi_p = \phi_y = 0$ and not estimated). m2 allows IID *s* deviations, estimating $\sigma^2_s$ but fixing $\phi_p = \phi_y = 0$. m3 estimates the full 2D AR1 structure for *s* deviations.

#### Environmental covariates (*Ecov*)

WHAM models environmental covariate data using state-space models with process and observation components. The true, unobserved values (or "latent states", $X_y$) are then linked to the population dynamics equations with user-specified lag. For example, recruitment in year *y* may be influenced by $X_{y-1}$ (lag 1), while natural mortality in year *y* may be influenced by $X_y$ (lag 0). Multiple environmental covariates may be included, but only as independent processes. The *Ecov* and population model years do not need to match, and missing years are allowed. In particular, including *Ecov* data in the projection period can be useful.

##### Process model

There are currently two options in WHAM for the *Ecov* process model: a normal random walk and AR1. We model the random walk as in @miller2016Statespace:

$$X_{y+1} | X_y \sim \mathcal{N}\left( X_y, \sigma^2_X\right)$$

where $\sigma^2_X$ is the process variance and $X_1$ is estimated as a fixed effect parameter. One disadvantage of the random walk is that its variance is nonstationary. In short-term projections, $\hat{X}_y$ will be equal to the last estimate with an observation and the uncertainty of $\hat{X}_y$ will increase over time. If $\hat{X}_y$ influences reference points, this leads to increasing uncertainty in stock status over time as well [@miller2016Statespace].

For this reason, we generally prefer to model $X_y$ as a stationary AR1 process as in @miller2018Temporal:

\begin{equation}
  \begin{array}{cc}
    X_1 \sim \mathcal{N} \left( \mu_X, \frac{\sigma^2_X}{1-\phi^2_X} \right) \\
    X_y \sim \mathcal{N} \left( \mu_X(1-\phi_X) + \phi_X X_{y-1}, \sigma^2_X \right)
  \end{array}
\end{equation}

where $\mu_X$, $\sigma^2_X$, and $|\phi_X| < 1$ are the marginal mean, variance, and autocorrelation parameters. In addition to having stationary variance, another important difference between the random walk and AR1 in short-term projections is that the AR1 will gradually revert to the mean over time, unless environmental covariate observations are included in the projection period.

##### Observation model

The environmental covariate observations, $x_y$, are assumed to be normally distributed with mean $X_y$ and variance $\sigma^2_{x_y}$:

$$x_y | X_y \sim \mathcal{N}\left( X_y, \sigma^2_{x_y} \right)$$

The observation variance in each year, $\sigma^2_{x_y}$, can be treated as known with year-specific values [as in @miller2016Statespace] or one overall value shared among years. They can also be estimated as parameters, likewise either as yearly values or one overall value. If yearly $\sigma^2_{x_y}$ estimates are desired, WHAM estimates the hyperparameters $\mu_{\sigma_x}$ and $\sigma_{\sigma_x}$ as fixed effects and treats the $\sigma^2_{x_y}$ as random effects:

$$\sigma^2_{x_y} \sim \mathcal{N} \left( \mu_{\sigma_x}, \sigma^2_{\sigma_x} \right)$$

##### Link to population

WHAM currently provides options to link the modeled environmental covariate, $X_y$, to the population dynamics via recruitment or natural mortality. It is also sometimes useful to fit the *Ecov* model without a link to the population dynamics so that models with and without environmental effects have the same data in the likelihood and can be compared via AIC.

In the case of recruitment, the options follow the framework laid out by @fry1971Effect and @iles1998Stock: "controlling" (density-independent mortality), "limiting" (carrying capacity effect, e.g. $X_y$ determines the amount of suitable habitat), "lethal" (threshold effect, i.e. $R_t$ goes to 0 at some $X_y$ value), "masking" ($X_y$ decreases $\text{d}R/\text{d}SSB$, as expected if $X_y$ affects metabolism or growth), and "directive" (e.g. behavioral). Of these, WHAM currently allows controlling, limiting, or masking effects in the Beverton-Holt stock-recruit function, and controlling or masking effects in the Ricker function. For natural mortality, environmental effects are placed on $\mu_M$, shared across ages by default.

Regardless of where the environment-population link is, the effect can be either linear or polynomial. Nonlinear effects of environmental covariates are common in ecology, and quadratic effects are to be expected in cases where intermediate values are optimal [@agostini2008Climateocean; @brett1971Energetic]. WHAM includes a function to calculate orthogonal polynomials in TMB, akin to the `poly()` function in `R`. 

In this analysis, we compare five models with limiting effects on Beverton-Holt recruitment: 

$$\hat{R}_{y+1} = \frac{\alpha \text{SSB}_{y}}{1 + e^{\beta_0 + \beta_1 X_{y} + \beta_2 X^2_{y}} \text{SSB}_y}$$

where $\text{SSB}_y$ is spawning stock biomass in year *y*, $\alpha$ and $\beta_0$ are the standard parameters of the Beverton-Holt function, and $\beta_1$ and $\beta_2$ are polynomial effect terms that modify $\beta_0$ based on the value of the estimated environmental covariate, $X_y$.

m1 treats $X_y$ as a random walk ($\phi_X = 1$) but does not include an effect on recruitment ($\beta_1 = \beta_2 = 0$). We include m1 in order to compare AIC of the original model to those with environmental effects on recruitment. m2 and m3 also treat $X_y$ as a random walk, but m2 estimates $\beta_1$ and m3 estimates both $\beta_1$ and $\beta_2$. m4 and m5 estimate $X_y$ as an AR1 process instead of a random walk (estimate $\phi_X$), and m4 estimates $\beta_1$ and m5 estimates both $\beta_1$ and $\beta_2$.

### Population observation model

Like ASAP, there are observation likelihood components for aggregate catch and abundance index for each fleet and index, and age composition for each fleet and index.

#### Aggregate catch and indices

The predicted catch at age for fleet $i$, $\hat{C}_{a,y,i}$, is a function of $N_{a,y}$, $M_{a,y}$, $F_{y,i}$, $s_{a,y,i}$, and empirical weight at age, $W_{a,y,i}$:

$$
\hat{C}_{a,y,i} = N_{a,y} W_{a,y,i}\left(1- e^{-Z_{a,y}}\right)\frac{F_{a,y,i}}{Z_{a,y}}.
$$

The log-aggregate catch $\hat{C}_{y,i} = \sum_a \hat{C}_{a,y,i}$ observation is assumed to have a normal distribution
\begin{equation}
\label{eq:catch}
  \begin{array}{ccc}
    \text{log}(C_{y,i}) \sim \mathcal{N}\left( \text{log}(\hat{C}_{y,i}) - \frac{\sigma^2_{C_{y,i}}}{2}, \sigma^2_{C_{y,i}}\right).
  \end{array}
\end{equation}
where the standard deviation 
$$
\sigma_{C_{y,i}} = e^{\eta_i}\sigma_{\tilde{C}_{y,i}}
$$
is a function of an input standard deviation $\sigma_{\tilde{C}_{y,i}}$ and a fleet-specific parameter $\eta_i$ that is fixed at 0 by default, but may be estimated. The bias correction term, $- \frac{\sigma^2_{C_{y,i}}}{2}$, is included by default based on @aldrin2020Specification but can be turned off.

Observations of aggregate indices of abundance are handled identically to the aggregate catch as in Eqn. \ref{eq:catch} except that for index $i$ the predicted index at age is 
$$\hat{I}_{a,y,i} = q_i s_{a,y,i} N_{a,y}W_{a,y,i} e^{-Z_{a,y}f_{y,i}}$$ 
where $q_i$ is the catchability and $f_{y,i}$ is the fraction of the annual time step elapsed when the index is observed. There are options for indices to be in terms of abundance (numbers) or biomass and $W_{a,y,i} = 1$ for the former.

#### Catch and index age composition

WHAM includes several options for the catch and index age compositions including multinomial (default), Dirichlet, Dirichlet-multinomial, logistic normal and a zero-one inflated logistic normal. In all of the applications and simulation studies here, we assumed a logistic normal distribution for age composition observations.

### Projections

The default settings for short-term projections follow common practice for stock assessments in the U.S. Northeast: the population is projected three years using the average selectivity, maturity, weight, and natural mortality at age from the last five model years to calculate reference points [@nefsc2020Operational]. WHAM implements similar options as ASAP for specifying $F_y$ in the projection years: terminal year $F_y$, average $F$ over specified years, $F_{X\%}$ ($F$ at X% SPR, where X is specified and 40 by default), user-specified $F_y$, or $F$ derived from user-specified catch. For all options except user-specified $F_y$, the uncertainty in projected F is propagated into the uncertainty of projected population attributes. For models with random effects on *NAA*, *M*, or *Ecov*, the default is to continue the stochastic process into the projection years. WHAM does not currently do this for selectivity because, like $F$, it is a function of management. Instead, selectivity is taken as the average of recent model years. 

If the *Ecov* data extend beyond the population model years, WHAM will fit the *Ecov* model to all available data and use the estimated $X_y$ in projections. This may often be the case because lags can exist in both the physical-biological mechanism and the assessment process. As an example, a model with an *Ecov* effect on recruitment may link physical oceanographic conditions, e.g. surface or bottom temperature, in year $t$ to recruitment in year $t+1$, and the assessment conducted in year $t$ may only use population data through year $t-1$. In this case, 3-year population projections only need the *Ecov* model to be projected one year. While the default handling of *Ecov* projections is to continue the stochastic process, WHAM includes options to use terminal year $x_y$, $x_y$ averaged over specified years, or specified $x_y$. The option to specify $x_y$ allows users to investigate how alternative climate projections may affect the stock.

## Fits to original datasets

We fit the models described above to data from five stocks with a broad range of life history, status, and model dimension (number of ages and years): Southern New England-Mid Atlantic (SNEMA) yellowtail flounder, butterfish, North Sea cod, Icelandic herring, and Georges Bank (GB) haddock (Tables \ref{tab:model-descriptions} and \ref{tab:stock-list}). We assumed the same form of logistic normal for SNEMA yellowtail flounder age composition observations as @miller2016Statespace where unobserved ages are pooled with adjascent ages, but for other stocks unobserved ages are treated as missing. The variance parameters associated with the logistic normal distributions were estimated for all stocks. We fit the *NAA* random effects models to all five stocks since these represent core WHAM functionality. We chose to highlight one stock each for the *M*, *s*, and *Ecov* processes because all models did not converge for all stocks and processes: butterfish (*M*), GB haddock (*s*), and SNEMA yellowtail flounder (*Ecov*). We fixed $\mu_{M_a}$ at the values used, or estimated as the case for butterfish, in the original assessments. Except for the GB haddock *s* models, we used the same selectivity parameterization and time blocks as in the original assessments. We used the m3 *NAA* model (all NAA deviations are IID random effects) in the *s* and *Ecov* demonstrations, but the m1 *NAA* model (only recruitment deviations are IID random effects) for the *M* demonstrations, because the NAA transitions can be interpreted as survival and including random effect deviations on both NAA and *M* can lead to model non-convergence [@stockthisissueImplementing]. For the SNEMA yellowtail flounder *Ecov* models, we used the Cold Pool Index (CPI) as calculated in @miller2016Statespace. We updated the CPI through 2018, except that the 2017 observation was missing because the NEFSC fall bottom trawl survey was not completed in the SNEMA region. Within each process, we compared the performance of the different random effects models using AIC.

We fit all models using the open-source statistical software R [@rcoreteam2020Language] and TMB [@kristensen2016TMB], as implemented in the R package WHAM [@miller2020Woods]. Documentation and tutorials for how to specify additional random effect structures in WHAM are available at https://timjmiller.github.io/wham/. Code and data files to run the analysis presented here are available at https://github.com/brianstock-NOAA/wham-sim.

## Simulation tests

After fitting each model to the original datasets, we used the simulation feature of TMB to conduct self- and cross-tests [*sensu* @deroba2015Simulation]. For each model, we generated 100 sets of new data and random effects, keeping the fixed effect parameters constant at values estimated in original fits. We then re-fit all models to datasets simulated under each as an operating model. We calculated the relative error in parameters constraining random effects (Table \ref{tab:model-descriptions}) and quantities of interest, such as spawning stock biomass (SSB), $F$, $\frac{\text{B}}{\text{B}_{40\%}}$, $\frac{F}{F_{40\%}}$, and $R$. We calculated relative error as $\frac{\hat{\theta_i}}{\theta_i}-1$, where $\theta_i$ is the true value for simulated dataset $i$ and $\hat{\theta}_i$ is the value estimated from fitting the model to the simulated data. To estimate bias of each estimation model for a given operating model, we calculated 95\% confidence intervals of the median relative error using the binomial distribution [@thompson1936Confidence]. To summarize the bias across simulations and years for each model, we calculated the median quantity across years and took the mean of the medians across simulations. Finally, for each operating model we calculated the proportion of simulations in which each estimation model converged and had the lowest AIC.

# Results

## Original datasets

The 2D AR1 covariance structure for random effects on *NAA*, *M*, and selectivity performed well across stocks and processes, evidenced by lower AIC than the IID random effects models (Fig. \ref{fig:daic}). This AIC difference was larger for selectivity than *NAA* or *M*, but the differences for *NAA* and *M* were also non-trivial, ranging from 11.1–53.2. Incorporating random effects on *NAA*, *M* or selectivity did not have consistently positive or negative effects on key assessment model output (SSB, *F*, or recruitment); these effects differed by stock and process (Figs. S1–S10). Models with random effects did have consistently wider confidence intervals in SSB, *F*, and recruitment (Figs. S1–S10). 

### Numbers-at-age (*NAA*)

Treating all ages as random effects was strongly supported by AIC, compared to treating only recruitment deviations as random effects (Fig. \ref{fig:daic}). Including autoregressive *NAA* random effects was also generally supported by AIC, either the AR1 when only recruitment deviations were random effects or the 2D AR1 when all ages were random effects. The estimated AR and IID random effects were similar, with the AR random effects slightly smoothed compared to the IID random effects (e.g. for Icelandic herring in Fig. \ref{fig:devs-ICEherring-naa}).

### Natural mortality (*M*)

As for the *NAA* models, including random effect deviations on *M* was supported by AIC (Fig. \ref{fig:daic}). Although the 2D AR1 *M* model did not converge for North Sea cod, it had the lowest AIC for butterfish and SNEMA yellowtail flounder. In contrast to the *NAA* models, the patterns in estimated 2D AR1 and IID *M* random effects differed noticeably (e.g. for butterfish in Fig. \ref{fig:devs-butterfish-m}). The butterfish IID *M* model estimated elevated *M* for age 5+ fish early and late in the time-series, with lower *M* in intervening years. The butterfish 2D AR1 *M* model estimated a similar, but much exaggerated, pattern for age 5+ fish and reduced *M* for ages 1 and 4. With $\mu_M$ held constant, negative *M* deviations in some ages and years were required to offset positive *M* deviations in others.

### Selectivity (*s*)

For Georges Bank haddock, including 2D AR1 random effect deviations on selectivity was strongly supported by AIC (Fig. \ref{fig:daic}). The 2D AR1 *s* model estimated similar patterns in selectivity compared to the IID *s* model, except with smoother variations by age and year (Fig. \ref{fig:devs-GBhaddock-sel}). Compared to the model with constant selectivity, the IID and 2D AR1 models estimated lower *s* for age 3 in recent years and higher *s* for age 3 before 1990. They also estimated higher *s* for age 2 before 1990, especially from 1973 to 1976.

### Environmental covariate effect on recruitment (*Ecov*)

As in previous analyses [@miller2016Statespace; @xu2018Evaluating], including an effect of the CPI on recruitment for SNEMA yellowtail flounder was clearly supported by AIC ($\Delta \text{AIC}$ of 20.3-33.0 between m1 and m2-m4, Fig. \ref{fig:daic}). The AR1-linear model (m4) had the lowest AIC—fitting the CPI using an AR1 model was preferred over the random walk ($\Delta \text{AIC}$ of 12.7 between m2 and m4), and the quadratic term, $\beta_2$, was deemed unnecessary ($\Delta \text{AIC}$ of 1.3 between m5 and m4). As expected, the AR1 process model estimated higher uncertainty in years with higher observation error (e.g. 1982–1992) and missing observations (2017, Fig. \ref{fig:devs-SNEMAYT-ecov}A). The CPI negatively influenced recruitment, i.e. $\hat{R}$ was higher following years with lower CPI (lower fall bottom temperature, Fig. \ref{fig:devs-SNEMAYT-ecov}C). Including the CPI-recruitment link changed the estimates of *R_y* by up to 30%, but in most years the relative difference in *R_y* was less than 10% (Figs. \ref{fig:devs-SNEMAYT-ecov}B–C and S3). The CPI-recruitment link model had far less influence on estimates of SSB or *F*, less than 4% difference in most years, especially compared to models with random effects on all NAA or *M* (Figs. S1–S3).

## Simulation tests

Several findings were consistent across processes and stocks. When the estimation and operating model were consistent, bias of SSB, $F$, $\frac{\text{B}}{\text{B}_{40\%}}$, $\frac{F}{F_{40\%}}$, and $R$ was generally small and not significant based on confidence intervals (Figs. \ref{fig:rel-error-ICEherring-naa}–\ref{fig:rel-error-GBhaddock-sel} and S11–S16). Bias was also generally small when more complex models were fitted to less complicated operating model simulations. In contrast, the bias was often non-trivial when the estimation model was less complex than the operating model, especially when models without random effects were fit to data simulated from models with random effects. Bias in SSB and $F$ were always opposite, i.e. when SSB was biased high, $F$ was biased low, and vice versa. Predicted catch was never biased. Bias of the variance and correlation parameters controlling random effects was generally negligible or negative, as expected (Figs. \ref{fig:estpar-naa}–\ref{fig:estpar-ecov}). Restricted maximum likelihood (REML) should be used if more accurate estimation of these parameters is a priority.

In cross-tests, the percentage of simulations in which AIC selected the correct model varied between 62–99\% by process, stock, and operating model (Fig. \ref{fig:aic-cross}). Estimation models more complex than the operating model were more likely to be chosen for *NAA* models than for *M* or selectivity.

### Numbers-at-age

Across the five stocks, all NAA models estimated SSB, $F$, $\frac{\text{B}}{\text{B}_{40\%}}$, $\frac{F}{F_{40\%}}$, and $R$ with very minimal bias in self-tests. An exception was the estimation of $F$ for Icelandic herring, particularly for the SCAA models (median relative error with 95\% CI for m1: -0.060 (-0.073, -0.047), m2: -0.060 (-0.073, -0.047), m3: 0.015 (-0.004, 0.034), and m4: 0.049 (0.017, 0.080); Figs. \ref{fig:rel-error-ICEherring-naa} and S17–S19). The convergence rate for most models and stocks was above 95\%, again with the exception of the SCAA models for Icelandic herring (Fig. S20). In cross-tests, SCAA models exhibited non-trivial bias when estimating data simulated from models that treated numbers at all ages as random effects. The degree of bias varied by quantity and stock between -25\% and 25% (Figs. \ref{fig:rel-error-ICEherring-naa} and S11–S14). The more complex NAA models estimated all quantities without bias regardless of operating model.

For four of the five stocks, $\sigma^2_R$ was estimated without bias in self-tests (Fig. \ref{fig:estpar-naa}). The exception was butterfish, for which $\sigma^2_R$ was negatively biased in m1, m2, and m4 (but not m3). In contrast, both m3 and m4 estimated $\sigma^2_a$ with negative bias for all five stocks. There was no consistent pattern in bias for the correlation parameters $\rho_a$ and $\rho_y$.

### Natural mortality

SSB, $F$, $\frac{\text{B}}{\text{B}_{40\%}}$, $\frac{F}{F_{40\%}}$, and $R$ were estimated without significant bias in self-tests, although less complex models exhibited bias when fit to data simulated from more complex models (Figs. \ref{fig:rel-error-butterfish-m} and S15–S16).

As for the *NAA* models, $\sigma^2_R$ was estimated without bias in the *M* model self-tests (Fig. \ref{fig:estpar-m}). $\sigma^2_M$ was biased low, $\varphi_y$ had no bias, and the direction of bias in $\varphi_a$ was inconsistent.

### Selectivity

Models with IID or 2D AR1 *s* random effects estimated SSB, $F$, $\frac{\text{B}}{\text{B}_{40\%}}$, $\frac{F}{F_{40\%}}$, and $R$ with little to no bias across operating models (Fig. \ref{fig:rel-error-GBhaddock-sel}). The model without *s* random effects, m1, showed substantial bias when fit to data simulated from m2 or m3. For Georges Bank haddock, the variance and correlation parameters $\sigma^2_a$, $\sigma^2_s$, $\phi_y$, and $\phi_a$ were all estimated with slight negative bias in self-tests of models with *s* random effects (Fig. \ref{fig:estpar-sel}).

### Ecov-Recruitment

The random walk CPI models estimated $\sigma^2_X$ with less bias than the AR1 CPI models (Fig. \ref{fig:estpar-ecov}). $\beta_0$ was biased high in all models, although this was not significant for the model with lowest AIC (m4, AR1-linear). All models estimated the parameters $\phi_X$, $\alpha$, $\beta_1$, and $\beta_2$ without significant bias.

# Discussion

## Overview

Our results suggest that the WHAM package can be a useful tool for stock assessment when environmental effects on recruitment, or stochastic changes in the numbers at age transitions, selectivity, or natural mortality are of interest. The simulation tests showed negligible or no bias in estimation of important assessment outputs (SSB, *F*, stock and harvest status) when the operating and estimation models matched. The less complex models, without random effects or autoregressive structure, exhibited some bias in cross-tests, while the more complex models did not. In these cases, bias in SSB and *F* were opposite such that predicted catch was unbiased. The WHAM models with IID or 2D AR1 random effect deviations performed well across stocks and processes, which suggests that they warrant consideration in future stock-specific studies.

## Relationships to other existing assessment model frameworks

WHAM assumes separability in $F_{a,y}$, i.e. $F_{a,y} = F_y s_a$, and estimates annual full $F_y$ as fixed effects and $s_a$ as constant or time-varying random effects with various autoregressive assumptions possible. Most other assessment frameworks in the U.S, e.g. ASAP, Stock Synthesis [SS; @methot2013Stock], an Assessment Model for Alaska [AMAK; @anon2015AMAK], and the Beaufort Assessment Model [BAM; @williams2015BAM], make this same separability assumption which is useful for specifying a fully-selected $F$ in projections to calculate reference points or generating catch advice. Estimating selectivity in time blocks is common practice in these frameworks. In contrast, SAM estimates $F_{a,y}$ directly as a multivariate random walk process [@nielsen2014Estimation]. The autoregressive models for selectivity parameters under certain configurations of WHAM should allow for similar $F$ at age patterns as in SAM. Stock Synthesis allows 2D AR1 random effects on $s_{a,y}$ instead of the parameters, and then the variance parameter is estimated by an iterative tuning algorithm [@xu2019New]. It is unclear whether estimating time-varying selectivity as random effects produces better results than assuming time blocks, or if there are advantages to using any of the three approaches for estimating time-varying selectivity used by WHAM, SAM, or SS.

Likewise, WHAM and the other U.S.-based assessment models treat catch, index, and composition observations differently than SAM. The U.S.-based assessment models treat aggregate and composition observations separately for fisheries and indices whereas SAM treats observations of catch and indices at age, $C_{a,y}$ and $I_{a,y}$, as multivariate log-normal.  Separate observation models for aggregate and composition observations is natural when sampling for total catch differs from that for length and age composition.

Like SAM, WHAM can estimate interannual transitions in NAA as a random walk processes, but WHAM can also be configured to treat these deviations as stationary autoregressive processes. Alternatively [or simultaneously, @stockthisissueImplementing] WHAM can estimate deviations in natural mortality as autoregressive processes like NCAM [@cadigan2016Statespace]. Uniquely, WHAM can model multiple environmental covariate time series as state-space processes and include their effects, possibly nonlinearly, in various ways on recruitment or natural mortality. Although most applications thusfar investigate effects of physical processes on demographic parameters, indices of predation might also be considered [@marshall2019Inclusion].

## Future use of WHAM

The productivity of several groundfish stocks in the U.S. Northeast has declined in recent decades, and conducting assessments in WHAM with time-varying processes via random effects or environment-productivity links could account for these trends and potentially reduce retrospective bias [@perretti2017Regime; @tableau2018Decadal; @stockthisissueImplementing]. WHAM can be configured to fit SCAA models very similar to ASAP and therefore bridge between the two frameworks. Adding random effects or environmental covariates to an assessment model is a large structural change, and simulation self- and cross-tests such as we have demonstrated here should be conducted through the research track process [@lynch2018Implementing]. If comparisons against status quo SCAA models prove favorable, WHAM could transition to being used in operational assessments. However, because the details of how to include time-varying processes, as well as the effect on the assessment output, will vary by stock, this evaluation may need to be conducted on a stock-by-stock basis.

Random effects allow for changing productivity and, if they are considered as an autoregressive process, can propagate the effect of these changes on assessment output in short-term projections [@stockthisissueImplementing]. However, the AR1 process demonstrated here trends to the mean in projections and will not predict values beyond extremes in observed time-series. This is an issue worth examining because many marine ecosystems are changing to such extent that recent conditions are time-series extremes, and conditions in the near future may continue to expand the range of observations [e.g., sea surface temperatures over the U.S. Northeast Shelf in the last decade; @chen2020Long]. More complex nonstationary time-series models such as autoregressive integrated moving average (ARIMA) that can forecast beyond observed values could be implemented. Nonlinear (e.g. splines) or double linear integration [@dilorenzo2013Doubleintegration] techniques could also be worth pursuing, as well as time-delay embedding methods [@munch2017Circumventing; @munch2018Nonlinear], which not only allow for nonstationary dynamics but also do not require a specified functional form. The best approach to making stochastic projections of productivity responses to environmental conditions that are rapidly changing and at time-series extremes merits further research.

In addition to the empirical (i.e. random effects) approach, it is worth considering the mechanistic approach (i.e. explicitly modeled links to environmental covariates) for a given stock whose recruitment or *M* is suspected to have shifted due to a clear, plausible hypothesized external influence. Several factors may result in a higher likelihood that the mechanistic approach is useful in an assessment: a history of overfishing [@free2019Impacts; but high *F* can also swamp the signal of an environmental influence, @haltuch2011Promises], more rapid environmental change, stocks at the edge of species' range, opportunistic (short-lived) species [*sensu* @winemiller1992Patterns], lower trophic level species, longer time series, periodic signals in which more than once cycle has been recorded (e.g. Pacific Decadal Oscillation and sardine), and stronger signals (wider ranges of observed stock status and environmental conditions) [@free2019Impacts; @haltuch2011Promises; @haltuch2019Unraveling; @marshall2019Inclusion]. Although developing mature mechanistic hypotheses will take significant effort and collaboration with ecologists and oceanographers, these rules of thumb can guide researchers in prioritizing which stocks to investigate environment-productivity relationships. Our ability to forecast and understand oceanographic and climate variables continues to improve and increasingly will present opportunities for including well-founded mechanistic environmental effects in stock assessments [@tommasi2017Managing].

The perception of precision in model output such as projected population biomass or catch advice is affected by whether productivity componenents are treated as either constant or stochastic processes (Figs. S1–S10), much like whether certain parameters are either fixed or estimated in traditional assessment models. Modeling frameworks such as WHAM allow the performance of these alternative models to be compared and when allowing temporal variation in productivity components is justified, the greater uncertainty in the assessment output is more realistic.  Moreover, model uncertainty could be included in our preception of output uncertainty by fitting ensembles of WHAM models that represent alternative states of nature [@anderson2017Improving; @mollmann2014Implementing]. Finally, the simulation capabilities of WHAM can also be useful in situations where variation in productivity is hypothesized, but information to estimate this variation is unavialable.  WHAM can be configured as an operating model to simulate plausible environmentally-driven changes in recruitment or *M* or plausible stochastic variation in order to estimate the sensitivity of status quo models. 

## Conclusion

A major present-day challenge in fisheries is to assess and manage stocks in a changing environment. We foresee environment-linked stock assessments becoming more feasible and realistic as fisheries and oceanographic time-series lengthen and our ecological understanding deepens. We have developed WHAM with this in mind. Finally, we note that the development of TMB has been a critical advance for fisheries assessment modeling frameworks such as WHAM, allowing us to rapidly fit models that treat population and environmental processes as time-varying random effects in a state-space framework.

## Acknowledgements {-}

This research was performed while BCS held an NRC Research Associateship award at the NEFSC under the Northeast Groundfish and Climate Initiative. We thank Chris Melrose for updating the Cold Pool Index with data through 2018, using code originally written by Jon Hare. 

\pagebreak

## References {-}

<div id="refs"></div>

\pagebreak

\begin{landscape}
```{r model-descriptions, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
dat <- data.frame(Model = c("m1: SCAA (IID)","m2: SCAA (AR1)","m3: NAA (IID)","m4: NAA (2D AR1)","m1: none","m2: IID","m3: 2D AR1","m1: none","m2: IID","m3: 2D AR1","m1: RW-none","m2: RW-linear","m3: RW-poly","m4: AR1-linear","m5: AR1-poly"),
                  Description = c("Recruitment deviations are IID random effects","Recruitment deviations are autocorrelated (AR1) random effects","All NAA deviations are IID random effects","All NAA deviations are random effects with correlation by year and age (2D AR1)","No random effects on $M$","$M$ deviations are IID random effects","$M$ deviations are random effects with correlation by year and age (2D AR1)","No random effects on selectivity","Selectivity deviations are IID random effects","Selectivity deviations are random effects with correlation by year and age (2D AR1)","Ecov: random walk (RW), effect on $\\beta$: none","Ecov: random walk (RW), effect on $\\beta$: linear","Ecov: random walk (RW), effect on $\\beta$: 2nd order polynomial (poly)","Ecov: autocorrelated (AR1), effect on $\\beta$: linear","Ecov: autocorrelated (AR1), effect on $\\beta$: 2nd order polynomial (poly)"),
                  Pars = c("$\\sigma_R$","$\\sigma_R$, $\\rho_y$","$\\sigma_R$, $\\sigma_a$","$\\sigma_R$, $\\sigma_a$, $\\rho_y$, $\\rho_a$",
                                             "$\\sigma_R$","$\\sigma_R$, $\\sigma_M$","$\\sigma_R$, $\\sigma_M$, $\\varphi_y$, $\\varphi_a$",
                                             "$\\sigma_R$, $\\sigma_a$","$\\sigma_R$, $\\sigma_a$, $\\sigma_{Sel}$","$\\sigma_R$, $\\sigma_a$, $\\sigma_{Sel}$, $\\phi_y$, $\\phi_a$",
                                             "$\\sigma_R$, $\\sigma_a$, $\\sigma_x$","$\\sigma_R$, $\\sigma_a$, $\\sigma_x$, $\\beta_1$","$\\sigma_R$, $\\sigma_a$, $\\sigma_x$, $\\beta_1$, $\\beta_2$","$\\sigma_R$, $\\sigma_a$, $\\sigma_x$, $\\phi_x$, $\\beta_1$","$\\sigma_R$, $\\sigma_a$, $\\sigma_x$, $\\phi_x$, $\\beta_1$, $\\beta_2$"))

dat %>% dplyr::rename("Estimated parameters"="Pars") %>%
  kable("latex", booktabs = T, escape=F, caption="Model descriptions and estimated parameters. Parameter descriptions and equations are given in text. Note that the base model in the $M$ module is NAA m1, and the base model in the Selectivity and Ecov-Recruitment modules is NAA m3. Ecov m1 fits the Cold Pool Index data and estimates $\\sigma_x$ in order to allow comparison to m2-m5 using AIC (same data needed in likelihood).") %>%
  kable_styling(latex_options=c("basic")) %>%
  group_rows("Numbers-at-age (NAA)", 1, 4) %>%
  group_rows("Natural mortality ($M$)", 5, 7, escape=F) %>%
  group_rows("Selectivity (Sel)", 8, 10) %>%
  group_rows("Ecov-Recruitment (Ecov)", 11, 15)
```
\end{landscape}

\pagebreak

\begin{landscape}
```{r stock-list, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
# # get biological par estimates from base models
# relB <- relF <- sigR <- rep(NA, 5)
# ids <- c("SNEMAYT","butterfish","NScod","ICEherring","GBhaddock")
# calc_relF <- function(mod){
#   sdrep = summary(mod$sdrep)
# 	ind.FXSPR <- which(rownames(sdrep) == "log_FXSPR")
# 	F.t <- sdrep[ind.FXSPR,1]
# 	ind.faa <- which(rownames(sdrep) == "log_FAA_tot")
# 	n.yrs <- length(mod$years_full)
# 	n.ages <- mod$env$data$n_ages
#   faa <- matrix(sdrep[ind.faa,1], n.yrs, n.ages)	
#   age.full.f <- apply(faa,1, function(x) max(which(x == max(x))))
#   full.f <- faa[cbind(seq_along(age.full.f),age.full.f)]
# 	rel.f <- exp(full.f - F.t)
# 	return(round(tail(rel.f,1),2))
# }
# calc_relB <- function(mod){
#   sdrep = summary(mod$sdrep)
# 	ind.SSB.FXSPR <- which(rownames(sdrep) == "log_SSB_FXSPR")
# 	SSB.t <- exp(sdrep[ind.SSB.FXSPR,1])
#   ind.ssb <- which(rownames(sdrep) == "log_SSB")
#   ssb <- exp(sdrep[ind.ssb,1])
# 	rel.ssb <- ssb / SSB.t	
# 	return(round(tail(rel.ssb,1),2))
# }
# for(i in 1:length(ids)){
#   # if(i==1){
#   #   m1 <- readRDS(file.path("results",paste0(ids[i],"_NAA_test"),"m1.rds"))
#   # } else { 
#   #   m1 <- readRDS(file.path("results","old-incorrect-bias-correction",paste0(ids[i],"_NAA"),"m1.rds"))
#   # }
#   m1 <- readRDS(file.path("results","bias_correct_oepe",paste0(ids[i],"_NAA_oepe"),"m1.rds"))
#   sigR[i] <- round(exp(m1$sdrep$par.fixed["log_NAA_sigma"]),2)
#   relB[i] <- calc_relB(m1)
#   relF[i] <- calc_relF(m1)
# }
# 
# dat <- data.frame(Stock = c("SNEMA yellowtail flounder", "Butterfish", "North Sea cod", "Icelandic herring", "Georges Bank haddock"),
#                   NAA = rep("x",5),
#                   M = c("x","x","x","",""),
#                   Sel = c("","","","","x"),
#                   Ecov = c("x","","","",""),
#                   n.ages = c(6,5,6,11,9),
#                   n.years = c(49,31,54,30,86),
#                   NatMort = c("0.2-0.4","1.3","0.2-1.2","0.1","0.2"),
#                   sig_R = sigR,
#                   relB = relB,
#                   relF = relF)

# saveRDS(dat, file.path("paper","table1_dat.rds"))
dat <- readRDS(file.path("paper","table1_dat.rds"))
dat$Source = c("NEFSC (2020a)", "NEFSC (2020b)","ICES (2017a)","ICES (2017b)","NEFSC (2020a)")

dat %>% dplyr::rename("$\\sigma_R$"="sig_R", "\\# Ages"='n.ages', "\\# Years"='n.years', "$M$"='NatMort', "$\\frac{B}{B_{40}}$"='relB', "$\\frac{F}{F_{40}}$"='relF') %>%
  kable("latex", booktabs = T, escape=F, caption="Stocks used in simulation tests.") %>%
  kable_styling(latex_options=c("basic")) %>%
  add_header_above(c(" "=1, "Processes tested"=4, "Model dim"=2, "Biol. par."=2, "Stock status"=2))
```
\end{landscape}

\pagebreak

\begin{landscape}
```{r daic, echo=FALSE, message=FALSE, warnings=FALSE, out.width='8in', fig.cap="AIC differences by model and stock when fit to original datasets. Stock abbreviations: SNEMA yellowtail flounder (SNEMAYT), North Sea cod (NScod), Icelandic herring (ICEherring), and Georges Bank haddock (GBhaddock)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","daic.png"))
```
\end{landscape}

\pagebreak

```{r devs-ICEherring-naa, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Abundanc-at-age deviations estimated for Icelandic herring using four models of numbers-at-age (NAA) random effects. m1 = only recruitment deviations are random effects (most similar to traditional statistical catch-at-age, SCAA), and deviations are independent and identically distributed (IID). m2 = as m1, but with autocorrelated recruitment deviations ($\\text{AR1}_y$). m3 = all NAA deviations are IID random effects. m4 = as m3, but deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_REdevs_ICEherring_NAA.png"))
```

\pagebreak

```{r devs-butterfish-m, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in', fig.cap="Natural mortality (\\textit{M}) estimated for butterfish using three random effects models. m1 = no random effects on \\textit{M}. m2 = \\textit{M} deviations are independent and identically distributed (IID). m3 = \\textit{M} deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_REdevs_butterfish_M.png"))
```

\pagebreak

```{r devs-GBhaddock-sel, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Selectivity estimated for Georges Bank haddock using three random effects models. m1 = no random effects (constant logistic selectivity). m2 = selectivity deviations are independent and identically distributed (IID). m3 = selectivity deviations are correlated by parameter and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_REdevs_GBhaddock_sel.png"))
```

\pagebreak

```{r devs-SNEMAYT-ecov, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in',fig.height=6.5, fig.width=6.5, fig.cap="Beverton-Holt stock-recruit relationships fit for Southern New England-Mid Atlantic yellowtail flounder, with and without effects of the Cold Pool Index (CPI). A) CPI estimated from the model with lowest AIC (m4, AR1-linear). Points are observations with 95\\% CI, and the line with shading is the model-estimated CPI with 95\\% CI. Note the increased uncertainty surrounding the CPI estimate in 2017 (no observation). B) Estimates of spawning stock biomass (SSB), recruitment, and the stock-recruit function from the model without a CPI effect, m1. C) Estimates of SSB and recruitment from m4, with an effect of the CPI on $\\beta$. Lines depict the expected stock-recruit relationship in each year $t$, given the CPI in year $t-1$ (color)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_CPI_Recruit_SNEMAYT_Ecov2.png"))
```

\pagebreak

```{r rel-error-ICEherring-naa, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Relative error of key quantities estimated for Icelandic herring using four models of numbers-at-age (NAA) random effects. m1 = only recruitment deviations are random effects (most similar to traditional statistical catch-at-age, SCAA), and deviations are independent and identically distributed (IID). m2 = as m1, but with autocorrelated recruitment deviations ($\\text{AR1}_y$). m3 = all NAA deviations are IID random effects. m4 = as m3, but deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","0_ICEherring_NAA_medianCI_OEPE.png"))
```

\pagebreak

```{r rel-error-butterfish-m, echo=FALSE, message=FALSE, warnings=FALSE, out.width='5in', fig.cap="Relative error of key quantities estimated for butterfish using three models of natural mortality (\\textit{M}) random effects. m1 = no random effects on \\textit{M}. m2 = \\textit{M} deviations are independent and identically distributed (IID). m3 = \\textit{M} deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","0_butterfish_M_medianCI_OEPE.png"))
```

\pagebreak

```{r rel-error-GBhaddock-sel, echo=FALSE, message=FALSE, warnings=FALSE, out.width='5in', fig.cap="Relative error of key quantities estimated for Georges Bank haddock using three models of selectivity random effects. m1 = no random effects (constant logistic selectivity). m2 = selectivity deviations are independent and identically distributed (IID). m3 = selectivity deviations are correlated by parameter and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","0_GBhaddock_sel_medianCI_OEPE.png"))
```

\pagebreak

```{r estpar-naa, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Relative error of parameters constraining numbers-at-age (NAA) random effects. Four models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. m1 = only recruitment deviations are random effects (most similar to traditional statistical catch-at-age, SCAA), and deviations are independent and identically distributed (IID). m2 = as m1, but with autocorrelated recruitment deviations ($\\text{AR1}_y$). m3 = all NAA deviations are IID random effects. m4 = as m3, but deviations are correlated by age and year (2D AR1). Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_NAA_OEPE.png"))
```

\pagebreak

```{r estpar-m, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in', fig.cap="Relative error of parameters constraining natural mortality (\\textit{M}) random effects. Three models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. m1 = no random effects on \\textit{M}. m2 = \\textit{M} deviations were independent and identically distributed (IID). m3 = \\textit{M} deviations were correlated by age and year (2D AR1). Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI. Stock abbreviations: SNEMA yellowtail flounder (SNEMAYT) and North Sea cod (NScod, m3 did not converge)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_M_4par_OEPE.png"))
```

\pagebreak

```{r estpar-sel, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Relative error of parameters constraining selectivity random effects for Georges Bank haddock (GBhaddock). Three models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. m1 = no random effects (constant selectivity). m2 = selectivity deviations were independent and identically distributed (IID). m3 = selectivity deviations were correlated by parameter and year (2D AR1). Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_sel_OEPE.png"))
```

\pagebreak

\begin{landscape}
```{r estpar-ecov, echo=FALSE, message=FALSE, warnings=FALSE, out.width='9in', fig.cap="Relative error of parameters constraining variation in recruitment for Southern New England-Mid Atlantic yellowtail flounder (SNEMAYT). Five models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. All models estimated recruitment using the Beverton-Holt function and included CPI effects on $\\beta$: $\\hat{R}_{t+1} = \\frac{\\alpha S_{t}}{1 + e^{\\beta_0 + \\beta_1 x_{t} + \\beta_2 x^2_{t}} S_t}$. m1 = Cold Pool Index (CPI) modeled as a random walk (RW) with no effect on recruitment ($\\beta_1 = \\beta_2 = 0$). m2 = CPI as RW, linear effect on $\\beta$. m3 = CPI as RW, 2nd order polynomial effect on $\\beta$. m4 = CPI as AR1, linear effect. m5 = CPI as AR1, polynomial effect. Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_Ecov2_OEPE.png"))
```
\end{landscape}

\pagebreak

```{r aic-cross, echo=FALSE, message=FALSE, warnings=FALSE, out.width='3.5in', fig.cap="Proportion of simulations in which each model had the lowest AIC. A) Numbers-at-age (NAA), aggregated across all five stocks. B) Natural mortality (\\textit{M}), aggregated over two stocks (SNEMAYT and butterfish). C) Selectivity (GBhaddock). Not all estimation models converged for each simulation, even when the operating model matched."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","aic_cross_multipanel.png"))
```

