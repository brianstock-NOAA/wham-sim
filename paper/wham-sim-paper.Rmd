---
title: 'The Woods Hole Assessment Model (WHAM): Incorporating environmental covariates into a state-space assessment framework'
author: Brian C. Stock^1^, Timothy J. Miller ^1^
date: ''
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    number_sections: true
    includes:
      in_header: options.sty
csl: fisheries-research.csl
bibliography: wham-sim.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE, fig.align = "center")
knitr::opts_knit$set(root.dir = '../' )
library(knitr)
library(tidyverse)
# library(cowplot)
# library(ggsidekick)
library(pander)
library(kableExtra)
library(png)
library(forcats)
library(wham)
# library(ggplotFL)
# library(ggsci)
```

$^1$brian.stock@noaa.gov, timothy.j.miller@noaa.gov, Northeast Fisheries Science Center, National Marine Fisheries Service, 166 Water Street, Woods Hole, MA 02543, USA\

\pagebreak

## Abstract {-}

WHAM is great.

### Keywords {-}

state-space; stock assessment; mixed effects; random effects; time-varying; Template Model Builder (TMB)

\pagebreak

# Introduction  

Grab stuff from NRC and Fish/Climate proposals.

## Context: assessments in the U.S. Northeast

- Long history, high F (pre-data)
- Empirical weight-at-age
- Retrospective patterns
- ASAP3/4
- Operational vs. research-track
- The Northeast U.S. Shelf LME is rapidly changing. Top priority is to "continue development of stock assessment models that include environmental terms" [@hare2016Northeast].

## Motivation #1: advantages of state-space stock assessments

- objective estimation of process errors and data weighting, e.g. $\sigma_R$, instead of ad-hoc
- inherently predict unobserved states, so predicting missing data/years and into the future is natural
- allow for time/age variation in demographic processes while estimating fewer parameters
- natural framework to include environmental time-series
- lower retros and AIC, larger (more realistic) uncertainty compared to SCAAs. Cite ICES state-space if in review.

[@aeberhard2018Review; @miller2016Statespace; @nielsen2014Estimation]

## Motivation #2: allow for environmental effects

- Reduced retrospective patterns
- Lower residual variance

[@miller2016Statespace; @miller2018Evaluating; @oleary2019Understanding]

## How is WHAM different from SAM?

*Not sure where to put this... may be more natural after introducing equations in Methods, some in Discussion. Definitely will be a question in readers' minds so may be good to introduce early?*

Most assessments in the U.S. assume separability in $F_{a,t}$, estimate $F_t$ and $Sel_a$. WHAM does this. SAM estimates $F_{a,t}$ directly. WHAM and SAM also make different separability assumptions for the catch/index data (aggregate total + age comps vs. $C_{a,t}$ directly). Should be similar (?) but could test.

Goal is to replicate ASAP assessments in the U.S. Northeast. Can easily turn on/off random effects.

Observation model is natural for landings data that are measured as total weight plus age composition sampling. Age composition sampling often done separately with survey data.

Treating $F$ and $Sel$ separately can be useful for projections. Oftentimes we want to specify $F$ in projections to calculate a reference point, as opposed to continuing a $F$ time-series process.

## Bias correction

- Analytical obs error. [@aldrin2020Specification].
- Analytical process error. 
- TMB epsilon. [@thorson2016Implementing; @thorson2019Perspective]

Should these all be used?

## Overview

In summary, the NEFSC wants an assessment framework that i) estimates random effects (i.e. a state-space model), ii) includes environmental effects, and iii) is easy to test against status quo SCAA models (ASAP). The objectives of this manuscript are to introduce the WHAM framework and demonstrate unbiasedness in self- and cross-tests.

# Methods

## Model description

### Unobserved states (random effects)

#### Numbers-at-age (survival)

#### Natural mortality ($M$)

#### Selectivity

#### Environmental covariate(s)
##### Time-series model
##### Observation model
##### Link to population

### Data/observation model

#### Catch (agg, age comp)
#### Index (agg, age comp)

## Simulation tests

We used the stocks in Table \ref{tab:stock-list}.

We used R [@rcoreteam2020Language]. WHAM is available as an R package [@miller2020Woods]. OSA residuals.

# Results

Sweet figures.

# Discussion

## Overview

We described WHAM. Sim tests showed no bias in self-tests (when estimation model matched operating model). Some bias in cross-tests.

## Future work

WHAM will be used in upcoming research track assessments. Could transition to operational. Potential to improve several NEFSC assessments.

- 2D AR(1) selectivity. Most assessments in the U.S. assume separability in $F_{a,t}$, i.e. estimate $F_t$ and $Sel_a$. WHAM does this. SAM estimates $F_{a,t}$ directly. WHAM and SAM make different separability assumptions for the catch/index data as well (aggregate total + age comps vs. $C_{a,t}$ directly). Should be similar (?) but could test.
- How many time/age-varying random effects can be estimated simultaneously? @stockthisissueImplementing estimated random effect deviations in survival and $M$, as well as an environmental covariate effect on recruitment.
- Ecov-Recruitment simulation study. How much information does Ecov need to have to be useful?

## Extensions

### Multivariate spatiotemporal environmental data
### Length/growth estimation
### Ecov models

- AR(k)
- splines
- Gaussian process/EDM/Munch/Sugihara

## Conclusion

Development of TMB has facilitated significant advancement in fisheries assessment, allowing us to treat population processes as random effects. A grand challenge in fisheries is to assess and manage stocks in a changing environment. Increasingly have the environmental data. Population time-series are lengthening. WHAM is a step in this direction.

## Acknowledgements {-}

This research was performed while BCS held an NRC Research Associateship award at the NEFSC. NOAA Fish & Climate grant number.

\pagebreak

## Supplementary material {-}

More figures.

\pagebreak

## References {-}

<div id="refs"></div>

\pagebreak

```{r stock-list, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
# # get biological par estimates from base models
# relB <- relF <- sigR <- rep(NA, 5)
# ids <- c("SNEMAYT","butterfish","NScod","ICEherring","GBhaddock")
# calc_relF <- function(mod){
#   sdrep = summary(mod$sdrep)
# 	ind.FXSPR <- which(rownames(sdrep) == "log_FXSPR")
# 	F.t <- sdrep[ind.FXSPR,1]
# 	ind.faa <- which(rownames(sdrep) == "log_FAA_tot")
# 	n.yrs <- length(mod$years_full)
# 	n.ages <- mod$env$data$n_ages
#   faa <- matrix(sdrep[ind.faa,1], n.yrs, n.ages)	
#   age.full.f <- apply(faa,1, function(x) max(which(x == max(x))))
#   full.f <- faa[cbind(seq_along(age.full.f),age.full.f)]
# 	rel.f <- exp(full.f - F.t)
# 	return(round(tail(rel.f,1),2))
# }
# calc_relB <- function(mod){
#   sdrep = summary(mod$sdrep)
# 	ind.SSB.FXSPR <- which(rownames(sdrep) == "log_SSB_FXSPR")
# 	SSB.t <- exp(sdrep[ind.SSB.FXSPR,1])
#   ind.ssb <- which(rownames(sdrep) == "log_SSB")
#   ssb <- exp(sdrep[ind.ssb,1])
# 	rel.ssb <- ssb / SSB.t	
# 	return(round(tail(rel.ssb,1),2))
# }
# for(i in 1:length(ids)){
#   # if(i==1){
#   #   m1 <- readRDS(file.path("results",paste0(ids[i],"_NAA_test"),"m1.rds"))
#   # } else { 
#   #   m1 <- readRDS(file.path("results","old-incorrect-bias-correction",paste0(ids[i],"_NAA"),"m1.rds"))
#   # }
#   m1 <- readRDS(file.path("results","bias_correct_oepe",paste0(ids[i],"_NAA_oepe"),"m1.rds"))
#   sigR[i] <- round(exp(m1$sdrep$par.fixed["log_NAA_sigma"]),2)
#   relB[i] <- calc_relB(m1)
#   relF[i] <- calc_relF(m1)
# }
# 
# dat <- data.frame(Stock = c("SNEMA yellowtail flounder", "Butterfish", "North Sea cod", "Icelandic herring", "Georges Bank haddock"),
#                   NAA = rep("x",5),
#                   M = c("x","x","x","",""),
#                   Sel = c("","","","","x"),
#                   Ecov = c("x","","","",""),
#                   n.ages = c(6,5,6,11,9),
#                   n.years = c(49,31,54,30,86),
#                   NatMort = c("0.2-0.4","1.3","0.2-1.2","0.1","0.2"),
#                   sig_R = sigR,
#                   relB = relB,
#                   relF = relF)

# saveRDS(dat, file.path("paper","table1_dat.rds"))
dat <- readRDS(file.path("paper","table1_dat.rds"))

dat %>% dplyr::rename("$\\sigma_R$"="sig_R", "\\# Ages"='n.ages', "\\# Years"='n.years', "$M$"='NatMort', "$\\frac{B}{B_{40}}$"='relB', "$\\frac{F}{F_{40}}$"='relF') %>%
  kable("latex", booktabs = T, escape=F, caption="Stocks used in simulation tests.") %>%
  kable_styling(latex_options=c("basic")) %>%
  add_header_above(c(" "=1, "Modules tested"=4, "Model dim"=2, "Biol. par."=2, "Stock status"=2))
```

\pagebreak

```{r devs-ICEherring-naa, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Survival deviations estimated for Icelandic herring using four models of numbers-at-age (NAA) random effects. m1 = only recruitment deviations are random effects (most similar to traditional statistical catch-at-age, SCAA), and deviations are independent and identically distributed (IID). m2 = as m1, but with autocorrelated recruitment deviations ($\\text{AR1}_y$). m3 = all NAA deviations are IID random effects. m4 = as m3, but deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_REdevs_ICEherring_NAA.png"))
```

\pagebreak

```{r devs-butterfish-m, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in', fig.cap="Natural mortality (\\textit{M}) estimated for butterfish using three random effects models. m1 = no random effects on \\textit{M}. m2 = \\textit{M} deviations are independent and identically distributed (IID). m3 = \\textit{M} deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_REdevs_butterfish_M.png"))
```

\pagebreak

```{r devs-GBhaddock-sel, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Selectivity estimated for Georges Bank haddock using three random effects models. m1 = no random effects (constant logistic selectivity). m2 = selectivity deviations are independent and identically distributed (IID). m3 = selectivity deviations are correlated by parameter and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_REdevs_GBhaddock_sel.png"))
```

\pagebreak

```{r devs-SNEMAYT-ecov, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in',fig.height=6.5, fig.width=6.5, fig.cap="Beverton-Holt stock-recruit relationships fit for Southern New England-Mid Atlantic yellowtail flounder, with and without effects of the Cold Pool Index (CPI). A) CPI estimated from the model with lowest AIC (m4, AR1-linear). Points are observations with 95\\% CI, and the line with shading is the model-estimated CPI with 95\\% CI. Note the increased uncertainty surrounding the CPI estimate in 2017 (no observation). B) Estimates of spawning stock biomass (SSB), recruitment, and the stock-recruit function from the model without a CPI effect, m1. C) Estimates of SSB and recruitment from m4, with an effect of the CPI on $\\beta$. Lines depict the expected stock-recruit relationship in each year $t$, given the CPI in year $t-1$ (color)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","8_CPI_Recruit_SNEMAYT_Ecov2.png"))
```

\pagebreak

\begin{landscape}
```{r daic, echo=FALSE, message=FALSE, warnings=FALSE, out.width='8in', fig.cap="AIC differences by model and stock when fit to full datasets. Stock abbreviations: SNEMA yellowtail flounder (SNEMAYT), North Sea cod (NScod), Icelandic herring (ICEherring), and Georges Bank haddock (GBhaddock)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","daic.png"))
```
\end{landscape}

\pagebreak

```{r estpar-naa, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Relative error of parameters constraining numbers-at-age (NAA) random effects. Four models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. m1 = only recruitment deviations are random effects (most similar to traditional statistical catch-at-age, SCAA), and deviations are independent and identically distributed (IID). m2 = as m1, but with autocorrelated recruitment deviations ($\\text{AR1}_y$). m3 = all NAA deviations are IID random effects. m4 = as m3, but deviations are correlated by age and year (2D AR1). Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_NAA_OEPE.png"))
```

\pagebreak

```{r estpar-m, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in', fig.cap="Relative error of parameters constraining natural mortality (\\textit{M}) random effects. Three models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. m1 = no random effects on \\textit{M}. m2 = \\textit{M} deviations were independent and identically distributed (IID). m3 = \\textit{M} deviations were correlated by age and year (2D AR1). Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI. Stock abbreviations: SNEMA yellowtail flounder (SNEMAYT) and North Sea cod (NScod, m3 did not converge)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_M_4par_OEPE.png"))
```

\pagebreak

```{r estpar-sel, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Relative error of parameters constraining selectivity random effects for Georges Bank haddock (GBhaddock). Three models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. m1 = no random effects (constant selectivity). m2 = selectivity deviations were independent and identically distributed (IID). m3 = selectivity deviations were correlated by parameter and year (2D AR1). Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_sel_OEPE.png"))
```

\pagebreak

\begin{landscape}
```{r estpar-ecov, echo=FALSE, message=FALSE, warnings=FALSE, out.width='9in', fig.cap="Relative error of parameters constraining variation in recruitment for Southern New England-Mid Atlantic yellowtail flounder (SNEMAYT). Five models were used to simulate 100 datasets keeping fixed effect parameters constant, and then re-fit to each simulated dataset. All models estimated recruitment using the Beverton-Holt function and included CPI effects on $\\beta$: $\\hat{R}_{t+1} = \\frac{\\alpha S_{t}}{1 + e^{\\beta_0 + \\beta_1 x_{t} + \\beta_2 x^2_{t}} S_t}$. m1 = Cold Pool Index (CPI) modeled as a random walk (RW) with no effect on recruitment ($\\beta_1 = \\beta_2 = 0$). m2 = CPI as RW, linear effect on $\\beta$. m3 = CPI as RW, 2nd order polynomial effect on $\\beta$. m4 = CPI as AR1, linear effect. m5 = CPI as AR1, polynomial effect. Relative error was calculated as $\\frac{\\hat{\\theta_i}}{\\theta} - 1$, where $\\hat{\\theta_i}$ was the estimate in simulation $i$ for parameter $\\theta$, and $\\theta$ was the true value (estimate from original dataset). Red points and lines show median relative error with 95\\% CI."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","estpar_Ecov2_OEPE.png"))
```
\end{landscape}

\pagebreak

```{r rel-error-ICEherring-naa, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6.5in', fig.cap="Relative error of key quantities estimated for Icelandic herring using four models of numbers-at-age (NAA) random effects. m1 = only recruitment deviations are random effects (most similar to traditional statistical catch-at-age, SCAA), and deviations are independent and identically distributed (IID). m2 = as m1, but with autocorrelated recruitment deviations ($\\text{AR1}_y$). m3 = all NAA deviations are IID random effects. m4 = as m3, but deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","0_ICEherring_NAA_medianCI_OEPE.png"))
```

\pagebreak

```{r rel-error-butterfish-m, echo=FALSE, message=FALSE, warnings=FALSE, out.width='5in', fig.cap="Relative error of key quantities estimated for butterfish using three models of natural mortality (\\textit{M}) random effects. m1 = no random effects on \\textit{M}. m2 = \\textit{M} deviations are independent and identically distributed (IID). m3 = \\textit{M} deviations are correlated by age and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","0_butterfish_M_medianCI_OEPE.png"))
```

\pagebreak

```{r rel-error-GBhaddock-sel, echo=FALSE, message=FALSE, warnings=FALSE, out.width='5in', fig.cap="Relative error of key quantities estimated for Georges Bank haddock using three models of selectivity random effects. m1 = no random effects (constant logistic selectivity). m2 = selectivity deviations are independent and identically distributed (IID). m3 = selectivity deviations are correlated by parameter and year (2D AR1)."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","0_GBhaddock_sel_medianCI_OEPE.png"))
```

\pagebreak

```{r aic-cross, echo=FALSE, message=FALSE, warnings=FALSE, out.width='3.5in', fig.cap="Proportion of simulations in which each model had the lowest AIC. A) Numbers-at-age (NAA), aggregated across all five stocks. B) Natural mortality (\\textit{M}), aggregated over two stocks (SNEMAYT and NScod). C) Selectivity (GBhaddock). Not all estimation models converged for each simulation, even when the operating model matched."}
knitr::include_graphics(file.path(getwd(),"plots","into_paper","aic_cross_multipanel.png"))
```
